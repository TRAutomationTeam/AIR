name: AI Code Review
on:
  push:
    paths:
      - 'TR_Sanity_TaxCaddy/**/*.xaml'
  pull_request:
    paths:
      - 'TR_Sanity_TaxCaddy/**/*.xaml'
jobs:
  review:
    runs-on: self-hosted
    env:
      GITHUB_WORKSPACE: 'D:/w'
      EXTRACT_PATH: 'D:/w/ext'
      VENV_PATH: 'D:/w/venv'
      ARCHIVE_PATH: 'D:/w/repo.tar.gz'
      TEMP_PATH: 'D:/w/temp'
    steps:
      - name: Setup Tools
        shell: pwsh
        run: |
          # Remove any attempted module imports from profile
          $ErrorActionPreference = 'SilentlyContinue'
          
          # Install 7-Zip
          Write-Host "Installing 7-Zip..."
          $7zipUrl = "https://www.7-zip.org/a/7z2301-x64.exe"
          $7zipInstaller = "$env:TEMP\7z2301-x64.exe"
          Invoke-WebRequest -Uri $7zipUrl -OutFile $7zipInstaller
          Start-Process -FilePath $7zipInstaller -Args "/S" -Wait
          $env:PATH = "C:\Program Files\7-Zip;$env:PATH"

          # Install Git
          Write-Host "Installing Git..."
          $gitUrl = "https://github.com/git-for-windows/git/releases/download/v2.42.0.windows.2/Git-2.42.0.2-64-bit.exe"
          $gitInstaller = "$env:TEMP\GitInstaller.exe"
          
          try {
              Write-Host "Downloading Git installer..."
              Invoke-WebRequest -Uri $gitUrl -OutFile $gitInstaller
              
              Write-Host "Installing Git..."
              $process = Start-Process -FilePath $gitInstaller -Args "/VERYSILENT /NORESTART /NOCANCEL /SP- /CLOSEAPPLICATIONS" -Wait -PassThru
              
              if ($process.ExitCode -ne 0) {
                  throw "Git installer failed with exit code: $($process.ExitCode)"
              }
              
              # Add Git to PATH
              $gitPath = "C:\Program Files\Git\cmd"
              $env:PATH = "$gitPath;$env:PATH"
              
              # Verify Git is accessible
              $ErrorActionPreference = 'Stop'
              $gitExe = Join-Path $gitPath "git.exe"
              
              if (-not (Test-Path $gitExe)) {
                  throw "Git executable not found at: $gitExe"
              }
              
              Write-Host "Running Git version check..."
              $version = & $gitExe --version
              Write-Host "Git installed successfully: $version"
              
          } catch {
              Write-Error "Failed to install Git: $_"
              exit 1
          }
      - name: Prepare Workspace
        shell: pwsh
        run: |
          Write-Host "Creating workspace directories..."
          New-Item -ItemType Directory -Force -Path "$env:GITHUB_WORKSPACE" | Out-Null
          New-Item -ItemType Directory -Force -Path "$env:EXTRACT_PATH" | Out-Null
          Write-Host "Enabling long path support..."
          try {
            if (-not (Test-Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem")) {
              New-Item -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Force | Out-Null
            }
            Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -Type DWord -Force
            Write-Host "Long paths enabled"
          } catch {
            Write-Warning "Could not enable long paths: $_"
          }
      - name: Download and Extract
        shell: pwsh
        run: |
          try {
            Write-Host "Downloading repository..."
            $headers = @{
              "Authorization" = "Bearer ${{ secrets.GITHUB_TOKEN }}"
              "Accept" = "application/vnd.github.v3.raw"
            }
            Invoke-WebRequest -Uri "https://api.github.com/repos/${{ github.repository }}/tarball/${{ github.sha }}" -Headers $headers -OutFile "$env:ARCHIVE_PATH"
            Write-Host "Extracting archives..."
            & "C:\Program Files\7-Zip\7z.exe" x "$env:ARCHIVE_PATH" -o"$env:TEMP_PATH" -y
            if ($LASTEXITCODE -ne 0) { throw "Failed to extract .gz" }
            $tarFile = Get-ChildItem "$env:TEMP_PATH" -Filter "*.tar" | Select-Object -First 1
            if (-not $tarFile) { throw "No .tar file found" }
            & "C:\Program Files\7-Zip\7z.exe" x $tarFile.FullName -o"$env:EXTRACT_PATH" -y
            if ($LASTEXITCODE -ne 0) { throw "Failed to extract .tar" }
            $extractedDir = Get-ChildItem "$env:EXTRACT_PATH" -Directory | Select-Object -First 1
            if (-not $extractedDir) { throw "No extracted directory found" }
            Write-Host "Moving files..."
            Get-ChildItem "$env:GITHUB_WORKSPACE" -Force | 
              Where-Object { $_.Name -notin @("temp", "ext", "venv") } |
              Remove-Item -Recurse -Force
            $robocopyResult = Start-Process "robocopy" -ArgumentList @(
              $extractedDir.FullName,
              "$env:GITHUB_WORKSPACE",
              "/E", "/MOVE", "/NFL", "/NDL", "/NJH", "/NJS", "/NC", "/NS", "/MT:16"
            ) -NoNewWindow -Wait -PassThru
            if ($robocopyResult.ExitCode -gt 7) { throw "Robocopy failed: $($robocopyResult.ExitCode)" }
          } catch {
            Write-Error $_
            exit 1
          } finally {
            Get-ChildItem -Path @("$env:TEMP_PATH", "$env:EXTRACT_PATH", "$env:ARCHIVE_PATH") -ErrorAction SilentlyContinue |
              Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
          }
      - name: Setup Python
        shell: pwsh
        run: |
          Write-Host "Looking for Python 3.8+..."
          
          function Test-PythonVersion {
              param([string]$pythonPath)
              try {
                  if (Test-Path $pythonPath) {
                      $version = & $pythonPath --version 2>&1
                      return $version -match "Python (3\.[89]|3\.[1-9][0-9])"
                  }
              } catch {
                  return $false
              }
              return $false
          }
          
          # First try: Check if python command is available
          $pythonExe = $null
          try {
              $pythonCmd = Get-Command python -ErrorAction Stop
              if (Test-PythonVersion $pythonCmd.Source) {
                  $pythonExe = $pythonCmd.Source
                  Write-Host "Found Python in PATH: $pythonExe"
              }
          } catch {
              Write-Host "Python not found in PATH"
          }
          
          # Second try: Search in common locations
          if (-not $pythonExe) {
              $commonPaths = @(
                  "C:\Python*\python.exe",
                  "$env:LOCALAPPDATA\Programs\Python\Python*\python.exe",
                  "C:\Program Files\Python*\python.exe",
                  "${env:ProgramFiles}\Python*\python.exe",
                  "${env:ProgramFiles(x86)}\Python*\python.exe"
              )
              
              foreach ($pattern in $commonPaths) {
                  try {
                      Get-ChildItem -Path $pattern -ErrorAction Stop | ForEach-Object {
                          if (-not $pythonExe -and (Test-PythonVersion $_.FullName)) {
                              $pythonExe = $_.FullName
                              Write-Host "Found Python in common location: $pythonExe"
                              break
                          }
                      }
                  } catch {
                      Write-Host "No Python found in $pattern"
                  }
              }
          }

          if (-not $pythonExe) {
              Write-Error "No Python 3.8+ found"
              exit 1
          }

          Write-Host "Creating venv..."
          & $pythonExe -m venv "$env:VENV_PATH"
          . "$env:VENV_PATH/Scripts/Activate.ps1"
          python -m pip install --upgrade pip
      - name: Install Dependencies
        shell: pwsh
        run: |
          . "$env:VENV_PATH/Scripts/Activate.ps1"
          $reqFile = "$env:GITHUB_WORKSPACE/src/requirements.txt"
          if (Test-Path $reqFile) {
            python -m pip install -r $reqFile --no-cache-dir
          } else {
            python -m pip install requests pandas openpyxl --no-cache-dir
          }
      - name: Run Review
        shell: pwsh
        env:
          AI_ARENA_API_KEY: ${{ secrets.AI_ARENA_API_KEY }}
          AI_ARENA_ENDPOINT: ${{ secrets.AI_ARENA_ENDPOINT }}
          GIT_PYTHON_GIT_EXECUTABLE: 'C:\Program Files\Git\cmd\git.exe'
        run: |
          # Verify Git is properly set up
          $gitExe = 'C:\Program Files\Git\cmd\git.exe'
          if (-not (Test-Path $gitExe)) {
              Write-Error "Git executable not found at expected location: $gitExe"
              exit 1
          }
          
          # Set required Git environment variables
          $env:GIT_PYTHON_GIT_EXECUTABLE = $gitExe
          $env:PATH = "C:\Program Files\Git\cmd;$env:PATH"
          
          Write-Host "Using Git from: $gitExe"
          Write-Host "Git version: $(git --version)"
          
          # Activate venv and run script
          . "$env:VENV_PATH/Scripts/Activate.ps1"
          python "$env:GITHUB_WORKSPACE/src/main.py"
      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-code-review-reports
          path: |
            ${{ env.GITHUB_WORKSPACE }}/src/AI Reports/*.html
            ${{ env.GITHUB_WORKSPACE }}/src/AI Reports/*.json
